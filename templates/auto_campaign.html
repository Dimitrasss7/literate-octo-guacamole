{% extends "base.html" %}

{% block title %}Автоматическая рассылка{% endblock %}

{% block content %}
<div class="container">
    <h2>Автоматическая рассылка</h2>

    <div class="card">
        <div class="card-header">
            <h5>Создать автоматическую рассылку</h5>
        </div>
        <div class="card-body">
            <form id="autoCampaignForm">
                <div class="mb-3">
                    <label for="account_id" class="form-label">Аккаунт</label>
                    <select class="form-select" id="account_id" name="account_id" required>
                        <option value="">Выберите аккаунт</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="target_types" class="form-label">Типы получателей</label>
                    <div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="private" id="target_private" checked>
                            <label class="form-check-label" for="target_private">
                                Приватные сообщения
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="groups" id="target_groups">
                            <label class="form-check-label" for="target_groups">
                                Группы
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="channels" id="target_channels">
                            <label class="form-check-label" for="target_channels">
                                Каналы
                            </label>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="delay_seconds" class="form-label">Задержка между сообщениями (секунды)</label>
                    <input type="number" class="form-control" id="delay_seconds" name="delay_seconds" value="5" min="1" max="300">
                </div>

                <div class="mb-3">
                    <label for="message" class="form-label">Сообщение</label>
                    <textarea class="form-control" id="message" name="message" rows="5" required placeholder="Введите текст сообщения..."></textarea>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <button type="button" class="btn btn-primary" onclick="createAutoCampaign()">Создать кампанию</button>
                    </div>
                    <div class="col-md-6">
                        <button type="button" class="btn btn-success" onclick="startAutoCampaign()">Создать и запустить</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="mt-4">
        <h4>Предварительный просмотр получателей</h4>
        <div id="previewContent">
            <p class="text-muted">Выберите аккаунт для просмотра контактов</p>
        </div>
        <div id="contactsStats" class="mt-2" style="display:none;">
            <small class="text-info">
                <i class="fas fa-info-circle"></i> 
                <span id="statsText">Загружается...</span>
            </small>
        </div>
    </div>
</div>

<script>
// Загрузка аккаунтов при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadAccounts();
});

async function loadAccounts() {
    try {
        const response = await fetch('/api/accounts');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const accounts = await response.json();

        const select = document.getElementById('account_id');
        select.innerHTML = '<option value="">Выберите аккаунт</option>';

        if (Array.isArray(accounts)) {
            accounts.forEach(account => {
                if (account.is_active) {
                    const option = document.createElement('option');
                    option.value = account.id;
                    option.textContent = `${account.name} (${account.phone})`;
                    select.appendChild(option);
                }
            });
        } else {
            console.error('Неожиданный формат ответа:', accounts);
        }
    } catch (error) {
        console.error('Ошибка загрузки аккаунтов:', error);
        alert('Ошибка загрузки списка аккаунтов. Проверьте консоль для деталей.');
    }
}

// Обновление превью при выборе аккаунта
document.getElementById('account_id').addEventListener('change', function() {
    if (this.value) {
        displayPreview(this.value);
    } else {
        document.getElementById('previewContent').innerHTML = 
            '<p class="text-muted">Выберите аккаунт для просмотра контактов</p>';
        document.getElementById('contactsStats').style.display = 'none';
    }
});

function displayPreview(accountId) {
                console.log("Загружаем данные для аккаунта:", accountId);

                const previewContent = document.getElementById('previewContent');
                const statsDiv = document.getElementById('contactsStats');

                previewContent.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Загружается...</div>';
                statsDiv.style.display = 'none';

                Promise.all([
                    fetch(`/api/contacts/${accountId}`),
                    fetch(`/api/chats/${accountId}`)
                ])
                .then(responses => {
                    console.log("Ответы получены. Статусы:", {
                        contacts: responses[0].status,
                        chats: responses[1].status
                    });
                    return Promise.all([
                        responses[0].json(),
                        responses[1].json()
                    ]);
                })
                .then(([contactsData, chatsData]) => {
                    console.log("Данные контактов:", contactsData);
                    console.log("Данные чатов:", chatsData);

                    let html = '';
                    let totalCount = 0;
                    let contactsCount = 0;
                    let groupsCount = 0;
                    let channelsCount = 0;

                    // Контакты
                    if (contactsData.status === 'success' && contactsData.contacts && contactsData.contacts.length > 0) {
                        contactsCount = contactsData.contacts.length;
                        html += `<h5><i class="fas fa-user-friends text-primary"></i> Личные контакты (${contactsCount}):</h5>`;
                        html += '<div class="contacts-container" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.25rem; padding: 10px;">';

                        contactsData.contacts.forEach((contact, index) => {
                            let displayText = contact.display_name || `User ${contact.id}`;
                            let additionalInfo = [];

                            if (contact.username) {
                                additionalInfo.push(`@${contact.username}`);
                            }
                            if (contact.phone) {
                                additionalInfo.push(contact.phone);
                            }

                            let badge = '';
                            if (contact.username) {
                                badge = '<span class="badge badge-primary">@</span> ';
                            }

                            let infoText = additionalInfo.length > 0 ? ` (${additionalInfo.join(', ')})` : '';

                            html += `<div class="contact-item mb-1 p-2 border-bottom">
                                        <div class="d-flex align-items-center">
                                            <span class="contact-number mr-2 text-muted" style="font-size: 0.8em;">${index + 1}.</span>
                                            ${badge}
                                            <strong>${displayText}</strong>
                                            <small class="text-muted ml-2">${infoText}</small>
                                        </div>
                                     </div>`;
                        });
                        html += '</div>';
                        totalCount += contactsCount;
                    } else if (contactsData.status === 'error') {
                        html += `<div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i> 
                                    Контакты: ${contactsData.message}
                                 </div>`;
                    }

                    // Чаты
                    if (chatsData.status === 'success' && chatsData.chats) {
                        // Группы
                        if (chatsData.chats.groups && chatsData.chats.groups.length > 0) {
                            groupsCount = chatsData.chats.groups.length;
                            html += `<h5 class="mt-3"><i class="fas fa-users text-success"></i> Группы (${groupsCount}):</h5>`;
                            html += '<ul class="list-group mb-3">';
                            chatsData.chats.groups.slice(0, 15).forEach((group, index) => {
                                let title = group.title || `Group ${group.id}`;
                                let username = group.username ? ` (@${group.username})` : '';
                                html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                                           <span>${index + 1}. ${title}${username}</span>
                                           <span class="badge badge-success">Группа</span>
                                         </li>`;
                            });
                            if (chatsData.chats.groups.length > 15) {
                                html += `<li class="list-group-item text-center text-muted">
                                           ... и еще ${chatsData.chats.groups.length - 15} групп
                                         </li>`;
                            }
                            html += '</ul>';
                            totalCount += groupsCount;
                        }

                        // Каналы
                        if (chatsData.chats.channels && chatsData.chats.channels.length > 0) {
                            channelsCount = chatsData.chats.channels.length;
                            html += `<h5><i class="fas fa-broadcast-tower text-info"></i> Каналы (${channelsCount}):</h5>`;
                            html += '<ul class="list-group mb-3">';
                            chatsData.chats.channels.slice(0, 10).forEach((channel, index) => {
                                let title = channel.title || `Channel ${channel.id}`;
                                let username = channel.username ? ` (@${channel.username})` : '';
                                html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                                           <span>${index + 1}. ${title}${username}</span>
                                           <span class="badge badge-info">Канал</span>
                                         </li>`;
                            });
                            if (chatsData.chats.channels.length > 10) {
                                html += `<li class="list-group-item text-center text-muted">
                                           ... и еще ${chatsData.chats.channels.length - 10} каналов
                                         </li>`;
                            }
                            html += '</ul>';
                            totalCount += channelsCount;
                        }
                    } else if (chatsData.status === 'error') {
                        html += `<div class="alert alert-warning mt-2">
                                    <i class="fas fa-exclamation-triangle"></i> 
                                    Чаты: ${chatsData.message}
                                 </div>`;
                    }

                    // Показываем статистику
                    if (totalCount > 0) {
                        const statsText = `Найдено получателей: ${totalCount} (контакты: ${contactsCount}, группы: ${groupsCount}, каналы: ${channelsCount})`;
                        document.getElementById('statsText').textContent = statsText;
                        statsDiv.style.display = 'block';

                        html = `<div class="alert alert-success mb-3">
                                   <i class="fas fa-check-circle"></i> 
                                   <strong>Готово к рассылке!</strong> Найдено получателей: ${totalCount}
                               </div>` + html;
                    } else {
                        html = `<div class="alert alert-warning">
                                   <i class="fas fa-exclamation-circle"></i> 
                                   <strong>Получатели не найдены</strong><br>
                                   Возможные причины: аккаунт заблокирован, нет диалогов, или проблемы с подключением
                               </div>`;
                    }

                    previewContent.innerHTML = html;
                })
                .catch(error => {
                    console.error("Ошибка загрузки превью:", error);
                    previewContent.innerHTML = `<div class="alert alert-danger">
                                                   <i class="fas fa-times-circle"></i> 
                                                   Ошибка загрузки данных: ${error.message}
                                               </div>`;
                });
            }

function getSelectedTargetTypes() {
    const types = [];
    if (document.getElementById('target_private').checked) types.push('private');
    if (document.getElementById('target_groups').checked) types.push('groups');
    if (document.getElementById('target_channels').checked) types.push('channels');
    return types;
}

async function createAutoCampaign() {
    const formData = {
        account_id: parseInt(document.getElementById('account_id').value),
        message: document.getElementById('message').value,
        delay_seconds: parseInt(document.getElementById('delay_seconds').value),
        target_types: getSelectedTargetTypes()
    };

    if (!formData.account_id || !formData.message) {
        alert('Пожалуйста, заполните все обязательные поля');
        return;
    }

    if (formData.target_types.length === 0) {
        alert('Выберите хотя бы один тип получателей');
        return;
    }

    try {
        const response = await fetch('/api/auto-campaign', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (result.status === 'success') {
            alert(`Кампания создана успешно! ID: ${result.campaign_id}, Получателей: ${result.recipients_count}`);
            window.location.href = '/campaigns';
        } else {
            alert(`Ошибка: ${result.message}`);
        }
    } catch (error) {
        console.error('Ошибка создания кампании:', error);
        alert('Произошла ошибка при создании кампании');
    }
}

async function startAutoCampaign() {
    const formData = {
        account_id: parseInt(document.getElementById('account_id').value),
        message: document.getElementById('message').value,
        delay_seconds: parseInt(document.getElementById('delay_seconds').value),
        target_types: getSelectedTargetTypes()
    };

    if (!formData.account_id || !formData.message) {
        alert('Пожалуйста, заполните все обязательные поля');
        return;
    }

    if (formData.target_types.length === 0) {
        alert('Выберите хотя бы один тип получателей');
        return;
    }

    if (!confirm('Запустить автоматическую рассылку? Это действие нельзя будет отменить.')) {
        return;
    }

    try {
        const response = await fetch('/api/auto-campaign/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (result.status === 'success') {
            alert(`Автоматическая рассылка запущена! ID: ${result.campaign_id}, Получателей: ${result.recipients_count}`);
            window.location.href = '/campaigns';
        } else {
            alert(`Ошибка: ${result.message}`);
        }
    } catch (error) {
        console.error('Ошибка запуска рассылки:', error);
        alert('Произошла ошибка при запуске рассылки');
    }
}
</script>
{% endblock %}