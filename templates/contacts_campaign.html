{% extends "base.html" %}

{% block title %}–†–∞—Å—Å—ã–ª–∫–∞ –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º - Telegram Mass Sender{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">–†–∞—Å—Å—ã–ª–∫–∞ –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º</h1>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-address-book"></i> –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º</h5>
            </div>
            <div class="card-body">
                <form id="contactsCampaignForm">
                    <div class="mb-3">
                        <label for="accountSelect" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç</label>
                        <select class="form-select" id="accountSelect" required>
                            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–æ–≤...</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="message" class="form-label">–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏</label>
                        <textarea class="form-control" id="message" rows="4" required 
                                  placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—Å–µ–º –∫–æ–Ω—Ç–∞–∫—Ç–∞–º"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="delaySeconds" class="form-label">–ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ (—Å–µ–∫—É–Ω–¥—ã)</label>
                        <input type="number" class="form-control" id="delaySeconds" value="5" min="1" max="60">
                        <small class="form-text text-muted">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 3-10 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫</small>
                    </div>

                    <div class="mb-3">
                        <label for="startInMinutes" class="form-label">–ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ (–º–∏–Ω—É—Ç)</label>
                        <input type="number" class="form-control" id="startInMinutes" placeholder="–°—Ä–∞–∑—É" min="1" max="1440">
                        <small class="form-text text-muted">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞. –ú–∞–∫—Å–∏–º—É–º 24 —á–∞—Å–∞ (1440 –º–∏–Ω—É—Ç)</small>
                    </div>

                    <div class="mb-3">
                        <label for="attachmentFile" class="form-label">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <input type="file" class="form-control" id="attachmentFile" accept="*/*">
                        <small class="form-text text-muted">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –ª—é–±—ã–µ —Ñ–∞–π–ª—ã: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –≤–∏–¥–µ–æ, –¥–æ–∫—É–º–µ–Ω—Ç—ã, APK –∏ –¥—Ä—É–≥–∏–µ. –ú–∞–∫—Å–∏–º—É–º 50 –ú–ë</small>
                        <div id="fileInfo" class="mt-2" style="display: none;">
                            <div class="alert alert-info">
                                <strong>–í—ã–±—Ä–∞–Ω —Ñ–∞–π–ª:</strong> <span id="fileName"></span><br>
                                <strong>–†–∞–∑–º–µ—Ä:</strong> <span id="fileSize"></span>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" id="startButton">
                            <i class="fas fa-paper-plane"></i> –°–æ–∑–¥–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
                        </button>
                        <button type="button" class="btn btn-info" id="previewButton">
                            <i class="fas fa-eye"></i> –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-users"></i> –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏</h5>
            </div>
            <div class="card-body">
                <div id="contactsPreview">
                    <p class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä", —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</p>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-clock"></i> –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏</h5>
            </div>
            <div class="card-body">
                <div id="scheduledCampaigns">
                    <p class="text-muted">–ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–†–µ–∑—É–ª—å—Ç–∞—Ç</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="resultMessage">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const accountSelect = document.getElementById('accountSelect');
    const contactsCampaignForm = document.getElementById('contactsCampaignForm');
    const previewButton = document.getElementById('previewButton');
    const contactsPreview = document.getElementById('contactsPreview');
    const scheduledCampaigns = document.getElementById('scheduledCampaigns');

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
    async function loadAccounts() {
        try {
            const response = await fetch('/api/accounts');
            const accounts = await response.json();

            accountSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç</option>';
            accounts.forEach(account => {
                if (account.is_active) {
                    const option = document.createElement('option');
                    option.value = account.id;
                    option.textContent = `${account.name} (${account.phone})`;
                    accountSelect.appendChild(option);
                }
            });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤:', error);
            accountSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤</option>';
        }
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏
    async function loadScheduledCampaigns() {
        try {
            const response = await fetch('/api/scheduled-campaigns');
            const data = await response.json();

            if (data.scheduled_campaigns && data.scheduled_campaigns.length > 0) {
                scheduledCampaigns.innerHTML = data.scheduled_campaigns.map(id => 
                    `<div class="d-flex justify-content-between align-items-center mb-2">
                        <span>–ö–∞–º–ø–∞–Ω–∏—è #${id}</span>
                        <button class="btn btn-sm btn-danger" onclick="cancelCampaign(${id})">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                    </div>`
                ).join('');
            } else {
                scheduledCampaigns.innerHTML = '<p class="text-muted">–ù–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫</p>';
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π:', error);
        }
    }

    // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
    previewButton.addEventListener('click', async function() {
        const accountId = accountSelect.value;
        if (!accountId) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç');
            return;
        }

        contactsPreview.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤...</p></div>';

        try {
            const response = await fetch(`/api/contacts/${accountId}`);
            const result = await response.json();

            if (result.status === 'success') {
                const contacts = result.contacts || [];
                if (contacts.length > 0) {
                    contactsPreview.innerHTML = `
                        <h6>–ù–∞–π–¥–µ–Ω–æ ${contacts.length} –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤:</h6>
                        <div class="contacts-list" style="max-height: 300px; overflow-y: auto;">
                            ${contacts.map(contact => 
                                `<div class="contact-item mb-2 p-2 border rounded">
                                    <strong>${contact.display_name}</strong>
                                    ${contact.phone ? `<br><small>üìû ${contact.phone}</small>` : ''}
                                    ${contact.username ? `<br><small>@${contact.username}</small>` : ''}
                                </div>`
                            ).join('')}
                        </div>
                    `;
                } else {
                    contactsPreview.innerHTML = '<p class="text-warning">–í –∞–¥—Ä–µ—Å–Ω–æ–π –∫–Ω–∏–≥–µ –∞–∫–∫–∞—É–Ω—Ç–∞ –Ω–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</p>';
                }
            } else {
                contactsPreview.innerHTML = `<p class="text-danger">–û—à–∏–±–∫–∞: ${result.message}</p>`;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤:', error);
            contactsPreview.innerHTML = '<p class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</p>';
        }
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
    contactsCampaignForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const accountId = accountSelect.value;
        const message = document.getElementById('message').value;
        const delaySeconds = parseInt(document.getElementById('delaySeconds').value);
        const startInMinutes = document.getElementById('startInMinutes').value;

        if (!accountId || !message) {
            alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
            return;
        }

        const startButton = document.getElementById('startButton');
        startButton.disabled = true;
        startButton.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> –°–æ–∑–¥–∞–Ω–∏–µ...';

        try {
            const formData = new FormData();
            formData.append('account_id', accountId);
            formData.append('message', message);
            formData.append('delay_seconds', delaySeconds);
            if (startInMinutes) {
                formData.append('start_in_minutes', startInMinutes);
            }

            const response = await fetch('/api/contacts-campaign/start', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            const resultMessage = document.getElementById('resultMessage');
            if (result.status === 'success') {
                resultMessage.innerHTML = `
                    <div class="alert alert-success">
                        <h6>–ö–∞–º–ø–∞–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!</h6>
                        <p>${result.message}</p>
                        ${result.scheduled_start ? `<p><strong>–í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞:</strong> ${result.scheduled_start}</p>` : ''}
                    </div>
                `;
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                contactsCampaignForm.reset();
                contactsPreview.innerHTML = '<p class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä", —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</p>';
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏
                loadScheduledCampaigns();
            } else {
                resultMessage.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–º–ø–∞–Ω–∏–∏</h6>
                        <p>${result.message}</p>
                    </div>
                `;
            }

            new bootstrap.Modal(document.getElementById('resultModal')).show();

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
            document.getElementById('resultMessage').innerHTML = `
                <div class="alert alert-danger">
                    <h6>–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</h6>
                    <p>–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å: ${error.message}</p>
                </div>
            `;
            new bootstrap.Modal(document.getElementById('resultModal')).show();
        } finally {
            startButton.disabled = false;
            startButton.innerHTML = '<i class="fas fa-paper-plane"></i> –°–æ–∑–¥–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É';
        }
    });

    // –û—Ç–º–µ–Ω–∞ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–∞–º–ø–∞–Ω–∏–∏
    window.cancelCampaign = async function(campaignId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç—É –∫–∞–º–ø–∞–Ω–∏—é?')) {
            return;
        }

        try {
            const response = await fetch(`/api/campaigns/${campaignId}/cancel`, {
                method: 'POST'
            });

            const result = await response.json();

            if (result.status === 'success') {
                alert('–ö–∞–º–ø–∞–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞');
                loadScheduledCampaigns();
            } else {
                alert('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã: ' + result.message);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –∫–∞–º–ø–∞–Ω–∏–∏:', error);
            alert('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –∫–∞–º–ø–∞–Ω–∏–∏');
        }
    };

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadAccounts();
    loadScheduledCampaigns();

    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(loadScheduledCampaigns, 30000);
});
</script>
{% endblock %}